# Email Collector API

Email Collector API — сервис на FastAPI для отправки и получения писем через SMTP/IMAP (Яндекс.Почта), с классификацией писем, проверкой на спам и маршрутизацией по типам.

---

## Возможности

- Отправка писем одному или нескольким получателям (To / CC / BCC) через SMTP.
- Получение писем из INBOX по IMAP с пагинацией.
- Парсинг писем: текст, HTML, вложения и встроенные изображения (всё складывается в `attachments`).
- Классификация писем по типам:
  - запрос на согласование
  - жалоба/претензия
  - запрос информации/документов
  - уведомление/информационное письмо
  - партнёрское предложение
  - регуляторный запрос
- Проверка на спам с учётом банковской специфики (фишинг, мошенничество, запросы карт/ПИН и т.п.).

---

## Технологический стек

- **Python** 3.12+
- **FastAPI** + **Uvicorn** для HTTP API.
- **smtplib / imaplib** (стандартная библиотека) для работы с почтой.
- **Pydantic** для валидации данных.
- **BeautifulSoup4** для очистки HTML-содержимого.

---

## Установка и запуск

### 1. Клонирование репозитория

```bash
git clone https://github.com/spTrent/mail_collector
cd mail_collector
```

### 2. Установка зависимостей

```bash
uv venv
source .venv/bin/activate
uv sync
```

### 3. Настройка окружения

Создайте файл `.env` в корне проекта:

```env
EMAIL_LOGIN=your_login@yandex.ru
EMAIL_PASSWORD=your_app_password
SMTP_HOST=smtp.yandex.ru
SMTP_PORT=465
IMAP_HOST=imap.yandex.ru
IMAP_PORT=993
```

Для Яндекс.Почты использовать пароль приложения.

### 4. Запуск сервера

```bash
uvicorn app.main:app --reload
```

- API: `http://127.0.0.1:8000`
- Swagger UI: `http://127.0.0.1:8000/docs`.

---

## Структура проекта

```text
app/
  main.py               # Точка входа FastAPI
  config.py             # Конфигурация и .env
  models.py             # Pydantic-схемы запросов/ответов
  services/
    email_service.py    # Отправка и получение писем (SMTP/IMAP)
    parser.py           # Парсинг текста/HTML/вложений
    classifier.py       # Классификация типа письма
    spam_detector.py    # Определение спама
  utils/
    formatters.py       # Декодирование заголовков, форматирование дат/отправителя
```

---

## API

### `POST /send/` — отправка письма

Отправляет письмо одному или нескольким получателям.

**Тело запроса:**

```json
{
  "to": ["user1@example.com", "user2@example.com"],
  "cc": [],
  "bcc": [],
  "subject": "Массовая рассылка",
  "text": "Это письмо отправлено нескольким получателям"
}
```

**Ответ:**

```json
{
  "status": "ok",
  "message": "Email успешно отправлен 2 получателям"
}
```

---

### `GET /emails/?offset=0` — получение писем

Возвращает письма из INBOX с пагинацией.

**Пример ответа:**

```json
{
  "items": [
    {
      "subject": "Запрос на согласование договора",
      "preview": "Добрый день! Прошу согласовать договор...",
      "type": "approval_request",
      "sender": "Иван Петров (ivan.petrov@company.ru)",
      "date": "Nov 29, 2025 at 09:15 AM",
      "body": "Добрый день! Прошу согласовать договор...",
      "html_body": "<div>Добрый день!...</div>",
      "attachments": [
        {
          "filename": "contract.pdf",
          "content_type": "application/pdf",
          "size": 245678,
          "data": "<base64>",
          "is_inline": false
        }
      ],
      "attachments_count": 1,
      "is_spam": false,
      "spam_score": 5,
      "spam_reasons": []
    }
  ],
  "next_offset": 20
}
```

---

### Классификация

`classifier.classify_email_type` считает совпадения русскоязычных ключевых слов по категориям (регуляторные запросы, жалобы, согласования и т.п.) и выбирает тип с максимальным “весом”.

### Антиспам (банковский контекст)

`spam_detector.is_spam` начисляет баллы за:

- фишинговые фразы (ПИН, CVV, "служба безопасности банка", "счёт заблокирован" и т.п.);
- подозрительные домены и временную почту;
- подделку брендов (Сбербанк, ВТБ, Тинькофф и др.) в имени отправителя;
- короткие ссылки и большое количество URL;
- опасные вложения (`.exe`, `.js` и др.).

Если суммарный балл ≥ порога (строже, чем обычно, для банков), письмо помечается как спам.

---
